---
import { getCollection } from "astro:content";
import { SITE_DESCRIPTION, SITE_TITLE } from "../../consts";
import BaseLayout from "../../layouts/BaseLayout.astro";

// 获取所有博客文章
const posts = await getCollection("blog");

// 按年份和月份组织文章
const postsByYear: Record<string, Record<string, typeof posts>> = {};

posts.forEach((post) => {
    const year = post.data.pubDate.getFullYear().toString();
    const month = (post.data.pubDate.getMonth() + 1)
        .toString()
        .padStart(2, "0");

    if (!postsByYear[year]) {
        postsByYear[year] = {};
    }
    if (!postsByYear[year][month]) {
        postsByYear[year][month] = [];
    }
    postsByYear[year][month].push(post);
});

// 按时间排序
Object.keys(postsByYear).forEach((year) => {
    Object.keys(postsByYear[year]).forEach((month) => {
        postsByYear[year][month].sort(
            (a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime(),
        );
    });
});

// 获取所有年份并排序
const allYears = Object.keys(postsByYear).sort(
    (a, b) => parseInt(b) - parseInt(a),
);

// 月份名称映射
const monthNames = [
    "一月",
    "二月",
    "三月",
    "四月",
    "五月",
    "六月",
    "七月",
    "八月",
    "九月",
    "十月",
    "十一月",
    "十二月",
];
---

<BaseLayout title={`归档 | ${SITE_TITLE}`} description={SITE_DESCRIPTION}>
    <main class="container mx-auto px-4 py-12">
        <div class="max-w-4xl mx-auto">
            <h1
                class="text-3xl font-bold mb-6 text-gray-800 dark:text-gray-100"
            >
                博客归档
            </h1>
            <p class="text-lg mb-8 text-gray-700 dark:text-gray-300">
                按时间浏览所有文章。
            </p>

            <div class="space-y-16">
                {
                    allYears.map((year) => (
                        <div>
                            <h2 class="text-2xl font-bold mb-6 border-b pb-2 border-gray-200 dark:border-gray-700 text-gray-800 dark:text-gray-100">
                                {year}年
                            </h2>

                            {Object.keys(postsByYear[year])
                                .sort((a, b) => parseInt(b) - parseInt(a))
                                .map((month) => (
                                    <div class="mb-8">
                                        <h3 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-200">
                                            {monthNames[parseInt(month) - 1]}
                                        </h3>
                                        <ul class="space-y-2">
                                            {postsByYear[year][month].map(
                                                (post) => (
                                                    <li class="flex flex-col sm:flex-row sm:items-center sm:justify-between border-b pb-2 border-gray-100 dark:border-gray-800">
                                                        <a
                                                            href={`/blog/${post.id}`}
                                                            class="text-blue-500 hover:text-blue-700 dark:hover:text-blue-300 font-medium"
                                                        >
                                                            {post.data.title}
                                                        </a>
                                                        <span class="text-sm text-gray-500 dark:text-gray-400">
                                                            {post.data.pubDate.toLocaleDateString(
                                                                "zh-CN",
                                                            )}
                                                        </span>
                                                    </li>
                                                ),
                                            )}
                                        </ul>
                                    </div>
                                ))}
                        </div>
                    ))
                }

                {
                    allYears.length === 0 && (
                        <div class="text-center py-12">
                            <p class="text-gray-500 dark:text-gray-400">
                                暂无文章
                            </p>
                        </div>
                    )
                }
            </div>
        </div>
    </main>
</BaseLayout>
